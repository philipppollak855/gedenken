<!-- backend/api/templates/admin/dashboard.html -->
{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block content %}
<div id="content-main">
    <div class="dashboard-header">
        <h1>{{ title }}</h1>
        <div id="current-datetime"></div>
    </div>
    <div class="dashboard-grid">
        
        <div class="dashboard-widget stat-widget">
            <h2>Auf einen Blick</h2>
            <div class="stat-grid">
                <a href="{% url 'admin:api_user_changelist' %}" class="stat-item-link">
                    <div class="stat-item">
                        <div class="value">{{ stats.total_users }}</div>
                        <div class="label">Benutzer</div>
                    </div>
                </a>
                <a href="{% url 'admin:api_memorialpage_changelist' %}" class="stat-item-link">
                    <div class="stat-item">
                        <div class="value">{{ stats.total_pages }}</div>
                        <div class="label">Gedenkseiten</div>
                    </div>
                </a>
                <a href="{% url 'admin:api_releaserequest_changelist' %}?status__exact=pending" class="stat-item-link">
                    <div class="stat-item warning">
                        <div class="value">{{ stats.pending_releases }}</div>
                        <div class="label">Offene Freigaben</div>
                    </div>
                </a>
                <a href="{% url 'admin:api_condolence_changelist' %}?is_approved__exact=0" class="stat-item-link">
                    <div class="stat-item danger">
                        <div class="value">{{ stats.unapproved_condolences }}</div>
                        <div class="label">Ungelesene Kondolenzen</div>
                    </div>
                </a>
            </div>
        </div>

        <div class="dashboard-widget quick-links-widget">
            <h2>Schnellzugriff</h2>
            <div class="quick-links">
                <a href="{% url 'admin:api_memorialpage_add' %}"><i class="fas fa-book-dead"></i> Neue Gedenkseite</a>
                <a href="{% url 'admin:api_user_add' %}"><i class="fas fa-user-plus"></i> Neuen Benutzer anlegen</a>
                <a href="{% url 'admin:api_releaserequest_changelist' %}"><i class="fas fa-key"></i> Freigabe-Anfragen prüfen</a>
                <a href="{% url 'admin:api_mediaasset_changelist' %}"><i class="fas fa-photo-video"></i> Mediathek verwalten</a>
            </div>
        </div>

        <div class="dashboard-widget activity-widget full-width">
            <div class="widget-header">
                <h2>Kommende Termine</h2>
                <i class="fas fa-calendar-alt calendar-icon" id="open-calendar-modal"></i>
            </div>
            <div class="event-grid">
                {% for event in upcoming_events_grid %}
                <a href="{% url 'admin:api_memorialevent_change' event.pk %}" class="event-card-link">
                    <div class="event-card">
                        <div class="event-card-header">
                            <div class="event-card-date">{{ event.date|date:"l, d. F Y" }}</div>
                            <div class="event-card-time">{{ event.date|date:"H:i" }} Uhr</div>
                        </div>
                        <div class="event-card-body">
                            <div class="event-card-title">{{ event.title }}</div>
                            <div class="event-card-page">für {{ event.page }}</div>
                            {% if event.location %}
                            <div class="event-card-location"><i class="fas fa-map-marker-alt"></i> {{ event.location.name }}</div>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% empty %}
                <p>Keine kommenden Termine gefunden.</p>
                {% endfor %}
            </div>
        </div>

        <div class="dashboard-widget activity-widget" id="condolence-widget">
            <div class="widget-header">
                <h2>Letzte Kondolenzen</h2>
                <i class="fas fa-expand-alt toggle-widget-icon"></i>
            </div>
            <div class="widget-content-source" style="display: none;">
                <input type="text" class="filter-input" data-target="condolence-list" placeholder="Kondolenzen filtern...">
                <div class="activity-list scrollable" id="condolence-list">
                    <ul>
                        {% for condolence in latest_condolences %}
                        <a href="{% url 'admin:api_condolence_change' condolence.condolence_id %}" class="list-item-link">
                            <li>
                                <strong>{{ condolence.guest_name }}</strong> für <a href="{% url 'admin:api_memorialpage_change' condolence.page.pk %}">{{ condolence.page }}</a>
                                <p class="message">{{ condolence.message }}</p>
                                <div class="meta">{{ condolence.created_at|timesince }} ago</div>
                            </li>
                        </a>
                        {% empty %}
                        <li>Keine Kondolenzen vorhanden.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="dashboard-widget activity-widget" id="candle-widget">
            <div class="widget-header">
                <h2>Letzte Gedenkkerzen</h2>
                <i class="fas fa-expand-alt toggle-widget-icon"></i>
            </div>
            <div class="widget-content-source" style="display: none;">
                <input type="text" class="filter-input" data-target="candle-list" placeholder="Kerzen filtern...">
                <div class="activity-list scrollable" id="candle-list">
                    <ul>
                        {% for candle in latest_candles %}
                        <a href="{% url 'admin:api_memorialcandle_change' candle.candle_id %}" class="list-item-link">
                            <li>
                                <strong>{{ candle.guest_name }}</strong> für <a href="{% url 'admin:api_memorialpage_change' candle.page.pk %}">{{ candle.page }}</a>
                                <p class="message">{{ candle.message }}</p>
                                <div class="meta">{{ candle.created_at|timesince }} ago</div>
                            </li>
                        </a>
                        {% empty %}
                        <li>Keine Kerzen angezündet.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kalender Modal -->
<div id="calendar-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="calendar-month-year"></h2>
            <div>
                <button id="prev-month">&lt;</button>
                <button id="next-month">&gt;</button>
                <span class="close-modal">&times;</span>
            </div>
        </div>
        <div class="calendar-grid-container">
            <div class="calendar-header">
                <div>Mo</div><div>Di</div><div>Mi</div><div>Do</div><div>Fr</div><div>Sa</div><div>So</div>
            </div>
            <div id="calendar-body" class="calendar-body"></div>
        </div>
        <div id="event-list-popup"></div>
    </div>
</div>

<!-- Generisches Widget Modal -->
<div id="widget-modal" class="modal">
    <div class="modal-content widget-modal-content">
        <div class="modal-header">
            <h2 id="widget-modal-title"></h2>
            <span class="close-modal">&times;</span>
        </div>
        <div id="widget-modal-body"></div>
    </div>
</div>

<!-- Übergibt die Event-Daten an das externe JavaScript -->
<script>
    window.calendarEvents = JSON.parse('{{ calendar_events_json|safe }}');
</script>
{% endblock %}
